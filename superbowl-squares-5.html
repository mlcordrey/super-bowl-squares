<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Bowl Squares ‚Äî Seahawks vs Patriots</title>
<link href="https://fonts.googleapis.com/css2?family=Anybody:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --team-a-color: #002244;
    --team-a-accent: #69BE28;
    --team-b-color: #002244;
    --team-b-accent: #C60C30;
  }

  body {
    min-height: 100vh;
    background: linear-gradient(160deg, #f8f9fb 0%, #eef1f5 40%, #f5f6f8 100%);
    color: #1a1a2e;
    font-family: 'Anybody', 'Oswald', sans-serif;
    padding: 20px;
    position: relative;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0; opacity: 0.025; z-index: 0; pointer-events: none;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 50px, #002244 50px, #002244 51px),
      repeating-linear-gradient(90deg, transparent, transparent 50px, #002244 50px, #002244 51px);
  }

  .container { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; }

  .sub-label {
    font-size: 11px; letter-spacing: 6px; text-transform: uppercase; color: #8a919c;
    font-family: 'Space Mono', monospace; margin-bottom: 6px; text-align: center;
  }

  h1 {
    font-size: clamp(28px, 5vw, 52px); font-weight: 900; text-align: center;
    line-height: 1.1; letter-spacing: -1px;
  }
  h1 .team-a { color: var(--team-a-color); }
  h1 .vs { color: #b0b7bc; font-size: 0.6em; margin: 0 12px; }
  h1 .team-b { color: var(--team-b-accent); }

  .claimed-count {
    margin-top: 8px; font-family: 'Space Mono', monospace; font-size: 13px;
    color: #8a919c; text-align: center;
  }

  .cta-area { text-align: center; margin: 24px 0; }

  .cta-btn {
    padding: 14px 36px; border-radius: 10px; border: none;
    background: linear-gradient(135deg, var(--team-a-color) 0%, var(--team-b-accent) 100%);
    color: #fff; font-family: 'Anybody', sans-serif;
    font-weight: 900; font-size: 18px; cursor: pointer;
    letter-spacing: 0.5px; box-shadow: 0 6px 24px rgba(0,34,68,0.25);
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }
  .cta-btn:hover {
    transform: scale(1.04); box-shadow: 0 8px 32px rgba(0,34,68,0.35);
  }
  .cta-btn:disabled {
    background: #A5ACAF; cursor: default; transform: none;
    box-shadow: none;
  }

  .cta-hint {
    margin-top: 8px; font-family: 'Space Mono', monospace; font-size: 12px; color: #8a919c;
  }

  .loading-bar {
    margin-top: 12px; text-align: center;
    font-family: 'Space Mono', monospace; font-size: 12px; color: #8a919c;
  }
  .spinner {
    display: inline-block; width: 18px; height: 18px;
    border: 2px solid #dde1e7; border-top-color: var(--team-a-color);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .grid-wrapper { overflow-x: auto; padding-bottom: 8px; }
  .grid-inner { min-width: 620px; margin: 0 auto; width: fit-content; }

  .axis-label-top {
    text-align: center; margin-bottom: 6px; font-weight: 900;
    font-size: clamp(14px, 2.5vw, 20px); color: var(--team-b-accent);
    letter-spacing: 3px; text-transform: uppercase;
  }

  .grid-body { display: flex; }

  .axis-label-left {
    writing-mode: vertical-lr; transform: rotate(180deg);
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: clamp(14px, 2.5vw, 20px);
    color: var(--team-a-accent); letter-spacing: 3px; text-transform: uppercase;
    padding-right: 6px; min-width: 30px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.15);
  }

  .col-headers { display: flex; margin-left: 52px; }
  .col-header {
    width: clamp(46px, 7vw, 56px); text-align: center;
    font-family: 'Space Mono', monospace; font-weight: 700;
    font-size: clamp(14px, 2vw, 18px); color: var(--team-b-accent); padding: 4px 0;
  }

  .grid-row { display: flex; align-items: center; }
  .row-header {
    width: 52px; text-align: center; flex-shrink: 0;
    font-family: 'Space Mono', monospace; font-weight: 700;
    font-size: clamp(14px, 2vw, 18px); color: var(--team-a-color);
  }

  .cell {
    width: clamp(46px, 7vw, 56px); height: clamp(46px, 7vw, 56px);
    margin: 1px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace;
    font-size: clamp(10px, 1.5vw, 13px); font-weight: 700;
    text-align: center; line-height: 1.2; user-select: none;
    transition: all 0.1s ease;
  }
  .cell.empty {
    background: #fff; border: 1px solid #dde1e7;
    color: rgba(0,34,68,0.15); box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .cell.claimed {
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.9); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
  }
  .cell.animating {
    background: rgba(251,191,36,0.35) !important;
    border: 2px solid #fbbf24 !important;
  }
  .cell.assigned {
    transform: scale(1.12);
    border: 2px solid var(--team-a-accent) !important;
    box-shadow: 0 0 20px rgba(105,190,40,0.33), 0 4px 16px rgba(0,0,0,0.12) !important;
  }

  .how-it-works {
    margin-top: 24px; padding: 16px 20px; background: #fff; border-radius: 8px;
    border: 1px solid #dde1e7; font-family: 'Space Mono', monospace;
    font-size: 12px; color: #6b7280; line-height: 1.7;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }

  .modal-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,34,68,0.4); backdrop-filter: blur(6px);
    display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.hidden { display: none; }

  .modal {
    background: #fff; border-radius: 16px; padding: 32px 28px;
    width: 100%; max-width: 420px; border: 1px solid #dde1e7;
    box-shadow: 0 24px 80px rgba(0,34,68,0.2);
  }

  .modal-title { font-weight: 900; font-size: 22px; margin-bottom: 4px; color: var(--team-a-color); }

  .modal-subtitle {
    font-family: 'Space Mono', monospace; font-size: 12px; color: #8a919c;
    margin-bottom: 6px; line-height: 1.5;
  }

  .modal-random-note {
    font-family: 'Space Mono', monospace; font-size: 11px;
    color: var(--team-b-accent); margin-bottom: 20px;
    display: flex; align-items: center; gap: 6px;
  }

  .form-group { margin-bottom: 16px; }
  .form-label {
    display: block; font-family: 'Space Mono', monospace;
    font-size: 11px; color: #6b7280; margin-bottom: 6px;
    letter-spacing: 1px; text-transform: uppercase;
  }
  .form-input {
    width: 100%; padding: 10px 14px; border-radius: 8px;
    border: 1px solid #dde1e7; background: #f8f9fb; color: #1a1a2e;
    font-family: 'Space Mono', monospace; font-size: 14px;
    outline: none; transition: border 0.2s;
  }
  .form-input::placeholder { color: #b0b7bc; }
  .form-input:focus { border-color: var(--team-a-color); }
  .form-input.error { border-color: var(--team-b-accent); }
  .form-error {
    color: var(--team-b-accent); font-size: 11px; margin-top: 4px;
    font-family: 'Space Mono', monospace; display: none;
  }
  .form-error.show { display: block; }

  .btn-row { display: flex; gap: 12px; margin-top: 24px; }

  .btn-cancel {
    flex: 1; padding: 12px 0; border-radius: 8px;
    border: 1px solid #dde1e7; background: #f8f9fb;
    color: #6b7280; font-family: 'Anybody', sans-serif;
    font-weight: 700; font-size: 14px; cursor: pointer;
  }

  .btn-submit {
    flex: 2; padding: 12px 0; border-radius: 8px; border: none;
    background: linear-gradient(135deg, var(--team-a-color) 0%, var(--team-b-accent) 100%);
    color: #fff; font-family: 'Anybody', sans-serif;
    font-weight: 900; font-size: 15px; cursor: pointer; letter-spacing: 0.5px;
  }
  .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

  .result-modal { text-align: center; max-width: 400px; padding: 36px 32px; }
  .result-emoji { font-size: 48px; margin-bottom: 8px; }
  .result-title { font-weight: 900; font-size: 24px; margin-bottom: 8px; color: var(--team-a-color); }
  .result-name {
    font-family: 'Space Mono', monospace; font-size: 14px; color: #6b7280;
    margin-bottom: 16px; line-height: 1.6;
  }
  .result-name strong { color: #1a1a2e; }

  .result-box {
    display: inline-flex; gap: 16px; align-items: center;
    background: #f8f9fb; border-radius: 12px; padding: 16px 28px;
    border: 1px solid #dde1e7; margin-bottom: 20px;
  }
  .result-team-label {
    font-family: 'Space Mono', monospace; font-size: 10px;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px;
  }
  .result-digit { font-family: 'Anybody', sans-serif; font-weight: 900; font-size: 36px; }
  .result-x { font-family: 'Space Mono', monospace; font-size: 18px; color: #b0b7bc; }
  .result-hint {
    font-family: 'Space Mono', monospace; font-size: 11px; color: #8a919c; margin-bottom: 20px;
  }

  .btn-gotit {
    padding: 12px 32px; border-radius: 8px; border: none;
    background: linear-gradient(135deg, var(--team-a-color) 0%, var(--team-b-accent) 100%);
    color: #fff; font-family: 'Anybody', sans-serif;
    font-weight: 900; font-size: 15px; cursor: pointer;
  }

  .error-modal { text-align: center; max-width: 400px; padding: 36px 32px; }
  .error-modal .error-msg {
    font-family: 'Space Mono', monospace; font-size: 13px; color: #6b7280;
    margin: 12px 0 20px; line-height: 1.6;
  }

  #debugLog {
    margin-top: 20px; padding: 12px; background: #f0f0f0; border-radius: 8px;
    font-family: 'Space Mono', monospace; font-size: 11px; color: #666;
    max-height: 150px; overflow-y: auto; display: none;
  }
</style>
</head>
<body>

<div class="container">
  <div class="sub-label">üèà Super Bowl Squares üèà</div>
  <h1>
    <span class="team-a">Seahawks</span><span class="vs">vs</span><span class="team-b">Patriots</span>
  </h1>
  <div class="claimed-count" id="claimedCount">Loading...</div>

  <div class="cta-area">
    <button class="cta-btn" id="ctaBtn" onclick="openForm()" disabled>üé≤ Enter &amp; Get a Random Square</button>
    <div class="cta-hint">Your square will be randomly assigned ‚Äî it's the luck of the draw!</div>
    <div class="loading-bar" id="loadingBar"><span class="spinner"></span> Loading grid from server...</div>
  </div>

  <div class="grid-wrapper">
    <div class="grid-inner">
      <div class="axis-label-top">‚Üê Patriots Score (Last Digit) ‚Üí</div>
      <div class="grid-body">
        <div class="axis-label-left">‚Üê Seahawks Score (Last Digit) ‚Üí</div>
        <div id="gridContainer"></div>
      </div>
    </div>
  </div>

  <div class="how-it-works">
    <strong style="color: var(--team-a-color);">How it works:</strong>
    Enter your info and a square will be <strong>randomly assigned</strong> to you ‚Äî no picking allowed!
    Each square maps to a unique combination of last digits for each team's score.
    At the end of each quarter, the square where the last digit of
    <span style="color: var(--team-a-color); font-weight: 700;">Seahawks</span>'s score (left axis)
    intersects with the last digit of
    <span style="color: var(--team-b-accent); font-weight: 700;">Patriots</span>'s score (top axis)
    wins that quarter's payout. Column and row numbers are randomly shuffled ‚Äî it's pure luck!
  </div>

  <div id="debugLog"></div>
</div>

<!-- Entry Form Modal -->
<div class="modal-overlay hidden" id="formModal" onclick="if(event.target===this)closeForm()">
  <div class="modal">
    <div class="modal-title">Enter the Grid</div>
    <div class="modal-subtitle" id="remainingText"></div>
    <div class="modal-random-note">üé≤ Your square is assigned by random draw</div>

    <div class="form-group">
      <label class="form-label" for="nameInput">Full Name</label>
      <input class="form-input" type="text" id="nameInput" placeholder="John Doe">
      <div class="form-error" id="nameError">Name is required</div>
    </div>
    <div class="form-group">
      <label class="form-label" for="addressInput">Address</label>
      <input class="form-input" type="text" id="addressInput" placeholder="123 Main St, City, ST 12345">
      <div class="form-error" id="addressError">Address is required</div>
    </div>
    <div class="form-group">
      <label class="form-label" for="emailInput">Email</label>
      <input class="form-input" type="email" id="emailInput" placeholder="john@example.com">
      <div class="form-error" id="emailError">Email is required</div>
    </div>

    <div class="btn-row">
      <button class="btn-cancel" onclick="closeForm()">Cancel</button>
      <button class="btn-submit" id="submitBtn" onclick="handleSubmit()">üé≤ Assign Me a Square!</button>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal-overlay hidden" id="resultModal" onclick="if(event.target===this)closeResult()">
  <div class="modal result-modal">
    <div class="result-emoji">üéâ</div>
    <div class="result-title">You Got Your Square!</div>
    <div class="result-name"><strong id="resultName"></strong>, your square is:</div>
    <div class="result-box">
      <div style="text-align: center;">
        <div class="result-team-label" style="color: var(--team-a-accent);">Seahawks</div>
        <div class="result-digit" style="color: var(--team-a-color);" id="resultDigitA"></div>
      </div>
      <div class="result-x">√ó</div>
      <div style="text-align: center;">
        <div class="result-team-label" style="color: var(--team-b-accent);">Patriots</div>
        <div class="result-digit" style="color: var(--team-b-accent);" id="resultDigitB"></div>
      </div>
    </div>
    <div class="result-hint">You win if any quarter ends with these as the last digits!</div>
    <button class="btn-gotit" onclick="closeResult()">Got It!</button>
  </div>
</div>

<!-- Error Modal -->
<div class="modal-overlay hidden" id="errorModal" onclick="if(event.target===this)closeError()">
  <div class="modal error-modal">
    <div class="result-emoji" style="font-size:40px">üò¨</div>
    <div class="result-title" style="color: var(--team-b-accent);">Oops!</div>
    <div class="error-msg" id="errorMsg"></div>
    <button class="btn-gotit" onclick="closeError()">Try Again</button>
  </div>
</div>

<script>
// ==============================================
// ‚ö†Ô∏è  PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL BELOW  ‚ö†Ô∏è
// ==============================================
const API_URL = "https://script.google.com/macros/s/AKfycbx4-wvdQcvxq3lXqzK5HGiP-STMr4wjjujzPtgzr7bmALJS-OKin8ddp0fxxCKLVtw/exec";
// ==============================================

// ---- CONFIG ----
const DEBUG = false; // Set to true to see debug log on page

function log(msg) {
  console.log("[SBSquares]", msg);
  if (DEBUG) {
    const el = document.getElementById("debugLog");
    el.style.display = "block";
    el.textContent += new Date().toLocaleTimeString() + " ‚Äî " + msg + "\n";
    el.scrollTop = el.scrollHeight;
  }
}

// ---- DETERMINISTIC SHUFFLE ----
function shuffleDigits(seed) {
  const digits = [0,1,2,3,4,5,6,7,8,9];
  for (let i = digits.length - 1; i > 0; i--) {
    const j = Math.floor((Math.abs(Math.sin(seed * (i + 1)) * 9301 + 49297) % 233280) / 233280 * (i + 1));
    [digits[i], digits[j]] = [digits[j], digits[i]];
  }
  return digits;
}

const colDigits = shuffleDigits(42);
const rowDigits = shuffleDigits(77);

const SQUARE_COLORS = [
  "#002244","#69BE28","#A5ACAF","#C60C30","#B0B7BC",
  "#003a1c","#1a3a5c","#8B0000","#4a7c2e","#3d5a80"
];

// ---- STATE ----
// squares[key] = null | { name, email }
const squares = {};
for (let r = 0; r < 10; r++)
  for (let c = 0; c < 10; c++)
    squares[r + "-" + c] = null;

let animatingKey = null;
let assignedKey = null;
let refreshTimerId = null;
let isSubmitting = false;

// ---- HELPERS ----
function getInitials(name) {
  return name.split(" ").map(function(w) { return w[0]; }).join("").toUpperCase().slice(0, 2);
}

function getColor(r, c) {
  return SQUARE_COLORS[(r * 10 + c) % SQUARE_COLORS.length];
}

function getClaimedCount() {
  let n = 0;
  for (const k in squares) if (squares[k]) n++;
  return n;
}

function getAvailable() {
  const arr = [];
  for (const k in squares) if (!squares[k]) arr.push(k);
  return arr;
}

// ---- API CALL (handles Google Apps Script redirect) ----
async function apiCall(params) {
  const url = API_URL + "?" + new URLSearchParams(params).toString();
  log("API call: " + params.action + " url length=" + url.length);

  // Google Apps Script Web Apps redirect (302) from the /exec URL.
  // We must use redirect: "follow" (the default) and the response
  // comes back as JSON from the final URL.
  const resp = await fetch(url, { redirect: "follow" });

  if (!resp.ok) {
    throw new Error("HTTP " + resp.status);
  }

  // Google sometimes returns HTML error pages instead of JSON
  const text = await resp.text();
  log("API response (" + params.action + "): " + text.substring(0, 200));

  try {
    return JSON.parse(text);
  } catch (e) {
    log("JSON parse failed, raw response: " + text.substring(0, 500));
    throw new Error("Invalid JSON from server");
  }
}

// ---- LOAD CLAIMED SQUARES FROM SERVER ----
async function loadFromServer() {
  log("Loading from server...");
  try {
    const data = await apiCall({ action: "getClaimed" });

    if (data.success && data.claimed) {
      // Reset all to null
      for (const k in squares) squares[k] = null;
      // Apply what server has
      for (const key in data.claimed) {
        if (data.claimed.hasOwnProperty(key) && squares.hasOwnProperty(key)) {
          squares[key] = data.claimed[key];
        }
      }
      log("Loaded " + (data.count || Object.keys(data.claimed).length) + " claimed squares");
    } else {
      log("Server returned unexpected data: " + JSON.stringify(data).substring(0, 200));
    }
  } catch (err) {
    log("Load error: " + err.message);
    console.error("Failed to load:", err);
  }
}

// ---- RENDER ----
function buildGrid() {
  const container = document.getElementById("gridContainer");
  container.innerHTML = "";

  const headerRow = document.createElement("div");
  headerRow.className = "col-headers";
  for (let c = 0; c < 10; c++) {
    const el = document.createElement("div");
    el.className = "col-header";
    el.textContent = colDigits[c];
    headerRow.appendChild(el);
  }
  container.appendChild(headerRow);

  for (let r = 0; r < 10; r++) {
    const row = document.createElement("div");
    row.className = "grid-row";

    const rh = document.createElement("div");
    rh.className = "row-header";
    rh.textContent = rowDigits[r];
    row.appendChild(rh);

    for (let c = 0; c < 10; c++) {
      const key = r + "-" + c;
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.id = "cell-" + key;
      renderCell(cell, key, r, c);
      row.appendChild(cell);
    }
    container.appendChild(row);
  }
}

function renderCell(cell, key, r, c) {
  const data = squares[key];
  // Reset classes
  cell.className = "cell";

  if (data) {
    cell.classList.add("claimed");
    cell.style.background = getColor(r, c);
    cell.textContent = getInitials(data.name);
    cell.title = data.name + "\n" + (data.email || "");
  } else {
    cell.classList.add("empty");
    cell.style.background = "#fff";
    cell.textContent = "";
    cell.title = "Row " + rowDigits[r] + ", Col " + colDigits[c];
  }

  if (key === assignedKey) cell.classList.add("assigned");
  if (key === animatingKey && !data) cell.classList.add("animating");
}

function refreshSingleCell(key) {
  const parts = key.split("-");
  const r = parseInt(parts[0]);
  const c = parseInt(parts[1]);
  const cell = document.getElementById("cell-" + key);
  if (cell) renderCell(cell, key, r, c);
}

function updateUI() {
  const count = getClaimedCount();
  document.getElementById("claimedCount").textContent = count + "/100 squares claimed";
  const btn = document.getElementById("ctaBtn");
  if (count >= 100) {
    btn.disabled = true;
    btn.textContent = "All Squares Claimed!";
  } else {
    btn.disabled = false;
    btn.textContent = "üé≤ Enter & Get a Random Square";
  }
  document.getElementById("loadingBar").style.display = "none";
}

// ---- AUTO REFRESH ----
function startAutoRefresh() {
  stopAutoRefresh();
  refreshTimerId = setInterval(async function() {
    if (isSubmitting) return; // Skip if mid-submission
    await loadFromServer();
    buildGrid();
    updateUI();
  }, 30000);
}

function stopAutoRefresh() {
  if (refreshTimerId) {
    clearInterval(refreshTimerId);
    refreshTimerId = null;
  }
}

// ---- FORM ----
function openForm() {
  if (getClaimedCount() >= 100) return;
  assignedKey = null;
  document.getElementById("nameInput").value = "";
  document.getElementById("addressInput").value = "";
  document.getElementById("emailInput").value = "";
  document.getElementById("submitBtn").disabled = false;
  document.getElementById("submitBtn").textContent = "üé≤ Assign Me a Square!";
  clearErrors();
  const remaining = 100 - getClaimedCount();
  document.getElementById("remainingText").textContent =
    "Fill out your info below and we'll randomly assign you one of the " + remaining + " remaining squares.";
  document.getElementById("formModal").classList.remove("hidden");
}

function closeForm() {
  document.getElementById("formModal").classList.add("hidden");
}

function clearErrors() {
  ["nameError","addressError","emailError"].forEach(function(id) {
    document.getElementById(id).classList.remove("show");
  });
  ["nameInput","addressInput","emailInput"].forEach(function(id) {
    document.getElementById(id).classList.remove("error");
  });
}

function validate() {
  clearErrors();
  let valid = true;
  const name = document.getElementById("nameInput").value.trim();
  const address = document.getElementById("addressInput").value.trim();
  const email = document.getElementById("emailInput").value.trim();

  if (!name) {
    document.getElementById("nameError").classList.add("show");
    document.getElementById("nameInput").classList.add("error");
    valid = false;
  }
  if (!address) {
    document.getElementById("addressError").classList.add("show");
    document.getElementById("addressInput").classList.add("error");
    valid = false;
  }
  if (!email) {
    document.getElementById("emailError").textContent = "Email is required";
    document.getElementById("emailError").classList.add("show");
    document.getElementById("emailInput").classList.add("error");
    valid = false;
  } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    document.getElementById("emailError").textContent = "Invalid email address";
    document.getElementById("emailError").classList.add("show");
    document.getElementById("emailInput").classList.add("error");
    valid = false;
  }
  return valid;
}

// ---- SUBMIT ----
async function handleSubmit() {
  if (!validate()) return;

  isSubmitting = true;
  log("Starting submission...");

  // Disable button
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "‚è≥ Checking available squares...";

  // 1. Refresh from server to get latest state
  try {
    await loadFromServer();
    buildGrid();
    updateUI();
  } catch (e) {
    log("Pre-refresh failed: " + e.message);
  }

  const available = getAvailable();
  if (available.length === 0) {
    isSubmitting = false;
    closeForm();
    showError("All squares have been claimed! Better luck next time.");
    return;
  }

  const name = document.getElementById("nameInput").value.trim();
  const address = document.getElementById("addressInput").value.trim();
  const email = document.getElementById("emailInput").value.trim();

  // Pick random square
  const targetKey = available[Math.floor(Math.random() * available.length)];
  const parts = targetKey.split("-");
  const tr = parseInt(parts[0]);
  const tc = parseInt(parts[1]);

  log("Claiming square " + targetKey + " (row digit " + rowDigits[tr] + ", col digit " + colDigits[tc] + ")");
  submitBtn.textContent = "‚è≥ Assigning...";

  // 2. Submit to server
  let serverResult;
  try {
    serverResult = await apiCall({
      action: "claim",
      square: targetKey,
      rowDigit: String(rowDigits[tr]),
      colDigit: String(colDigits[tc]),
      name: name,
      address: address,
      email: email
    });
  } catch (err) {
    log("Submit failed: " + err.message);
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "üé≤ Assign Me a Square!";
    closeForm();
    showError("Network error ‚Äî please check your connection and try again.");
    return;
  }

  if (!serverResult.success) {
    log("Server rejected: " + (serverResult.error || "unknown"));
    isSubmitting = false;
    submitBtn.disabled = false;
    submitBtn.textContent = "üé≤ Assign Me a Square!";
    closeForm();
    // Refresh grid since state changed
    await loadFromServer();
    buildGrid();
    updateUI();
    showError(serverResult.error || "Something went wrong. Please try again.");
    return;
  }

  // 3. SUCCESS ‚Äî immediately update local state BEFORE animation
  log("Server confirmed claim for " + targetKey);
  squares[targetKey] = { name: name, email: email };

  closeForm();

  // 4. Run animation (purely visual, data is already saved)
  let flashCount = 0;
  const totalFlashes = 14;
  let prevFlashKey = null;

  const interval = setInterval(function() {
    // Clear previous flash
    if (prevFlashKey) {
      animatingKey = null;
      refreshSingleCell(prevFlashKey);
    }
    // Flash a random available-looking cell
    const flashKey = available[Math.floor(Math.random() * available.length)];
    animatingKey = flashKey;
    refreshSingleCell(flashKey);
    prevFlashKey = flashKey;
    flashCount++;

    if (flashCount >= totalFlashes) {
      clearInterval(interval);
      // Clear last flash
      animatingKey = null;
      if (prevFlashKey) refreshSingleCell(prevFlashKey);

      // Land on the target
      animatingKey = targetKey;
      refreshSingleCell(targetKey);

      setTimeout(function() {
        animatingKey = null;
        assignedKey = targetKey;
        refreshSingleCell(targetKey);
        updateUI();
        showResultModal(name, targetKey);

        // Resume auto-refresh after a short delay
        setTimeout(function() {
          isSubmitting = false;
          // Do a full server sync to make sure everything is in order
          loadFromServer().then(function() {
            buildGrid();
            updateUI();
            startAutoRefresh();
          });
        }, 5000);
      }, 400);
    }
  }, 120);
}

// ---- RESULT MODAL ----
function showResultModal(name, key) {
  const parts = key.split("-");
  const r = parseInt(parts[0]);
  const c = parseInt(parts[1]);
  document.getElementById("resultName").textContent = name;
  document.getElementById("resultDigitA").textContent = rowDigits[r];
  document.getElementById("resultDigitB").textContent = colDigits[c];
  document.getElementById("resultModal").classList.remove("hidden");
}

function closeResult() {
  document.getElementById("resultModal").classList.add("hidden");
  if (assignedKey) {
    const prev = assignedKey;
    assignedKey = null;
    refreshSingleCell(prev);
  }
}

// ---- ERROR MODAL ----
function showError(msg) {
  document.getElementById("errorMsg").textContent = msg;
  document.getElementById("errorModal").classList.remove("hidden");
}

function closeError() {
  document.getElementById("errorModal").classList.add("hidden");
}

// ---- INIT ----
(async function init() {
  log("Initializing...");
  log("API URL: " + (API_URL === "YOUR_APPS_SCRIPT_URL_HERE" ? "‚ö†Ô∏è NOT SET" : "‚úì Set"));
  await loadFromServer();
  buildGrid();
  updateUI();
  startAutoRefresh();
  log("Ready. " + getClaimedCount() + " squares claimed.");
})();
</script>
</body>
</html>
